---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Serialize posts for client-side carousel
const serializedPosts = sortedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate.toISOString(),
}));
---

<BaseLayout title="Code, Math, AI and Hardware">
  <div class="space-y-24">
    <!-- Hero Section -->
    <section class="text-center py-24">
      <h1 class="text-6xl font-bold text-title mb-6 leading-tight tracking-tight">
        Code, Math, AI and Hardware
      </h1>
      <p class="text-xl text-slate-300 max-w-3xl mx-auto leading-relaxed">
        Probability theory • Coding • Hacking • 3D printing • Machine learning
      </p>
    </section>

    <!-- Recent Posts Carousel Section -->
    <section>
      <hr class="border-slate-600 mb-12">

      <div class="flex items-center justify-center mb-6">
        <h2 class="text-3xl font-bold text-title">Recent Posts</h2>
      </div>

      <div class="relative">
        <!-- Left Arrow (initially hidden) -->
        <button
          id="prev-arrow"
          class="absolute left-0 top-40 w-16 h-16 rounded-full bg-surface-hover border-2 border-slate-600 text-slate-300 hover:text-primary-400 hover:border-primary-500 hover:bg-surface-light transition-all duration-200 flex items-center justify-center group invisible z-10"
          aria-label="Previous posts"
        >
          <svg class="w-10 h-10 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <!-- Posts Container -->
        <div class="px-24 flex items-center min-h-96">
          <div id="posts-container" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 transition-all duration-500 w-full">
            {sortedPosts.slice(0, 3).map(post => (
              <PostCard post={post} />
            ))}
          </div>
        </div>

        <!-- Right Arrow -->
        <button
          id="next-arrow"
          class="absolute right-0 top-40 w-16 h-16 rounded-full bg-surface-hover border-2 border-slate-600 text-slate-300 hover:text-primary-400 hover:border-primary-500 hover:bg-surface-light transition-all duration-200 flex items-center justify-center group z-10"
          aria-label="Next posts"
        >
          <svg class="w-10 h-10 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </section>
  </div>
</BaseLayout>

<script define:vars={{ posts: serializedPosts }}>
  const prevArrow = document.getElementById('prev-arrow');
  const nextArrow = document.getElementById('next-arrow');
  const postsContainer = document.getElementById('posts-container');

  let currentIndex = 0;
  const postsPerView = 3;
  const totalPosts = posts.length;

  function updateArrows() {
    if (!prevArrow || !nextArrow) return;

    // Disable transitions for immediate effect
    prevArrow.style.transition = 'none';
    nextArrow.style.transition = 'none';

    // Hide/show left arrow
    if (currentIndex === 0) {
      prevArrow.classList.add('invisible');
    } else {
      prevArrow.classList.remove('invisible');
    }

    // Hide/show right arrow
    if (currentIndex + postsPerView >= totalPosts) {
      nextArrow.classList.add('invisible');
    } else {
      nextArrow.classList.remove('invisible');
    }

    // Force reflow to apply changes
    prevArrow.offsetHeight;
    nextArrow.offsetHeight;

    // Re-enable transitions for hover effects
    prevArrow.style.transition = '';
    nextArrow.style.transition = '';
  }

  function renderPosts() {
    if (!postsContainer) return;

    const postsToShow = posts.slice(currentIndex, currentIndex + postsPerView);

    // Immediately hide content
    postsContainer.style.transition = 'none';
    postsContainer.style.opacity = '0';

    // Force browser to apply opacity change
    postsContainer.offsetHeight;

    // Update content
    postsContainer.innerHTML = '';

    postsToShow.forEach(post => {
      const postCard = document.createElement('a');
      postCard.href = `/blog/${post.slug}`;
      postCard.className = 'group bg-surface rounded-lg shadow-soft hover:shadow-soft-lg transition-all duration-300 p-8 h-full flex flex-col border border-slate-600 hover:border-primary-500 hover:scale-[1.02] cursor-pointer';

      const postDate = new Date(post.pubDate);
      const formattedDate = postDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

      postCard.innerHTML = `
        <h3 class="text-xl font-bold mb-3 leading-tight text-title group-hover:text-primary-400 transition-colors duration-200">
          ${post.title}
        </h3>
        <p class="text-slate-300 mb-6 flex-grow leading-relaxed">
          ${post.description}
        </p>
        <div class="flex items-center justify-between text-sm pt-4 border-t border-slate-600">
          <time datetime="${post.pubDate}" class="text-slate-400 font-medium">
            ${formattedDate}
          </time>
          <span class="text-title group-hover:text-primary-400 font-semibold inline-flex items-center group-hover:translate-x-1 transition-all duration-200">
            Read more
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </span>
        </div>
      `;

      postsContainer.appendChild(postCard);
    });

    // Force browser to apply new content
    postsContainer.offsetHeight;

    // Quick fade-in (100ms)
    postsContainer.style.transition = 'opacity 100ms ease-in-out';
    postsContainer.style.opacity = '1';
  }

  if (prevArrow) {
    prevArrow.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex -= postsPerView;
        if (currentIndex < 0) currentIndex = 0;
        updateArrows();
        renderPosts();
      }
    });
  }

  if (nextArrow) {
    nextArrow.addEventListener('click', () => {
      if (currentIndex + postsPerView < totalPosts) {
        currentIndex += postsPerView;
        updateArrows();
        renderPosts();
      }
    });
  }

  // Initial arrow state
  updateArrows();
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
</style>
