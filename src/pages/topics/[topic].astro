---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '../../../site.config';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  const TOPICS = siteConfig.topics;

  return TOPICS.map(({ name, slug }) => {
    const filteredPosts = allPosts
      .filter(post =>
        !post.data.draft &&
        post.data.topics.some(t => t.toLowerCase().replace(/\s+/g, '-') === slug)
      )
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    return {
      params: { topic: slug },
      props: { topic: name, posts: filteredPosts },
    };
  });
}

const { topic, posts } = Astro.props;
const topicInfo = siteConfig.topics.find(t => t.name === topic);
const description = topicInfo?.description || `Blog posts about ${topic}`;
---

<BaseLayout title={`${topic} - Topics`} description={description}>
  <div class="max-w-6xl mx-auto">
    <div class="mb-16 text-center">
      <a href="/topics" class="text-title hover:text-primary-400 font-semibold inline-flex items-center mb-8 transition-colors duration-200">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Topics
      </a>

      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-title mb-4 tracking-tight">
        {topic}
      </h1>
      <p class="text-xl text-slate-300">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'} in this topic
      </p>
    </div>

    {posts.length > 0 ? (
      <div class="space-y-8">
        {posts.map(post => (
          <article class="bg-surface rounded-lg shadow-soft border border-slate-600 p-8 hover:border-primary-500 transition-colors duration-200">
            <a href={`/blog/${post.slug}`} class="group block">
              <div class="flex items-start justify-between mb-4">
                <h2 class="text-2xl sm:text-3xl font-bold text-title group-hover:text-primary-400 transition-colors duration-200 flex-grow pr-6">
                  {post.data.title}
                </h2>
                <time datetime={post.data.pubDate.toISOString()} class="text-slate-400 text-sm font-medium whitespace-nowrap flex-shrink-0">
                  {post.data.pubDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </time>
              </div>

              <hr class="border-slate-600 mb-4" />

              <div class="flex items-start justify-between gap-6">
                <p class="text-lg text-slate-300 leading-relaxed flex-grow">
                  {post.data.description}
                </p>
                <span class="text-title group-hover:text-primary-400 font-semibold inline-flex items-center whitespace-nowrap flex-shrink-0 group-hover:translate-x-1 transition-all duration-200">
                  Read more
                  <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </span>
              </div>
            </a>
          </article>
        ))}
      </div>
    ) : (
      <div class="text-center py-16 bg-surface rounded-lg border border-slate-600">
        <p class="text-slate-300 text-lg">
          No posts found in this topic yet.
        </p>
      </div>
    )}
  </div>
</BaseLayout>
